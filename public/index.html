const express = require('express');
const http = require('http');
const socketIo = require('socket.io');
const mineflayer = require('mineflayer');
const pathfinder = require('mineflayer-pathfinder').pathfinder;
const { GoalBlock } = require('mineflayer-pathfinder').goals;
const path = require('path');

const app = express();
const server = http.createServer(app);
const io = socketIo(server);

let bot;

// Coordenadas para onde o bot deve retornar apÃ³s acordar
const homeCoordinates = { x: 100, y: 65, z: 100 };

// Criar o bot
function createBot() {
  bot = mineflayer.createBot({
    host: 'survival.406rec.com',
    port: 25565,
    username: 'Serjao',
    version: '1.21.4',
  });

  bot.loadPlugin(pathfinder);

  bot.once('spawn', () => {
    io.emit('chatMessage', 'ğŸ¤– Bot entrou no servidor!');
    
    // Login automÃ¡tico
    setTimeout(() => {
      bot.chat('/login 12345678');
    }, 500);
  });

  bot.on('chat', (username, message) => {
    if (username !== bot.username) {
      io.emit('chatMessage', `<${username}> ${message}`);
    }
  });

  bot.on('message', jsonMsg => {
    io.emit('chatMessage', jsonMsg.toString());
  });

  bot.on('error', err => {
    console.log('âŒ Erro:', err);
    io.emit('chatMessage', 'âŒ Bot encontrou um erro.');
  });

  bot.on('end', () => {
    io.emit('chatMessage', 'ğŸ”Œ Bot desconectado. Tentando reconectar...');
    setTimeout(createBot, 5000);
  });
}

// Comando: dormir
async function botSleep() {
  const bed = bot.findBlock({
    matching: block => bot.isABed(block),
    maxDistance: 6,
  });

  if (!bed) return io.emit('botCommandResponse', 'ğŸ›ï¸ Nenhuma cama encontrada por perto.');

  try {
    await bot.sleep(bed);
    bot.chat('ğŸ˜´ Indo dormir...');
    io.emit('botCommandResponse', 'âœ… Bot foi dormir!');
  } catch (err) {
    io.emit('botCommandResponse', 'âŒ Erro ao dormir: ' + err.message);
  }
}

// Comando: acordar e ir atÃ© as coordenadas
async function botWakeUp() {
  if (!bot.isSleeping) {
    return io.emit('botCommandResponse', 'ğŸ˜´ Bot jÃ¡ estÃ¡ acordado.');
  }

  try {
    await bot.wake();
    bot.chat('â˜€ï¸ Acordei! Voltando pra casa...');
    bot.pathfinder.setGoal(new GoalBlock(homeCoordinates.x, homeCoordinates.y, homeCoordinates.z));
    io.emit('botCommandResponse', 'âœ… Bot acordou e estÃ¡ indo para as coordenadas.');
  } catch (err) {
    io.emit('botCommandResponse', 'âŒ Erro ao acordar: ' + err.message);
  }
}

// Servir arquivos do front-end
app.use(express.static(path.join(__dirname, 'public')));

// Sockets
io.on('connection', (socket) => {
  console.log('ğŸ§‘ Novo usuÃ¡rio conectado');

  socket.on('chatMessage', msg => {
    if (bot) bot.chat(msg);
  });

  socket.on('botCommand', cmd => {
    switch (cmd.toLowerCase()) {
      case 'dormir':
        botSleep();
        break;
      case 'acordar':
        botWakeUp();
        break;
      default:
        io.emit('botCommandResponse', `â“ Comando desconhecido: ${cmd}`);
    }
  });
});

// Iniciar servidor e bot
createBot();
const PORT = process.env.PORT || 3000;
server.listen(PORT, () => {
  console.log(`ğŸŒ Servidor rodando na porta ${PORT}`);
});
